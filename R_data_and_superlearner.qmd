---
title: "Data Structure & Machine Learning Ensembles"
engine: knitr
filters:
  - webr
webr:
  packages: ['lmtp']
  autoload-packages: true
---

```{webr-r}
library(lmtp)
```

### Specifying the Data Structure

#### Point-treatment

![Adapted from Hoffman et al., 2022.](images/data_point_trt.png){fig-align="center" width="60%"}

```{webr-r}
set.seed(56)
n <- 1000
W <- rnorm(n, 10, 5)
A <- 23 + 5*W + rnorm(n)
Y <- 7.2*A + 3*W + rnorm(n)
foo <- data.frame(W, A, Y)
head(foo)
```

#### Point-treatment w/loss-to-follow-up

![Adapted from Hoffman et al., 2022.](images/data_ltfu.png){fig-align="center" width="60%"}

```{webr-r}
head(sim_cens[, c("L1", "A1", "C1", "Y")])
```

#### Time-varying treatment

![Adapted from Hoffman et al., 2022.](images/data_time_varying.png){fig-align="center" width="90%"}

```{webr-r}
head(sim_t4)
```

#### Point-treatment w/survival outcome

![Adapted from Hoffman et al., 2022.](images/data_survival.png){fig-align="center" width="85%"}

```{webr-r}
head(sim_point_surv)
```

#### Time-varying treatment w/survival outcome

![Adapted from Hoffman et al., 2022.](images/data_complex.png){fig-align="center" width="100%"}

### Machine Learning Ensembles

An attractive property of multiply-robust estimators is that they can incorporate flexible machine-learning algorithms for the estimation of nuisance parameters while remaining $\sqrt{n}$-consistent. The super learner algorithm is an ensemble learner than incorporates a set of candidate models through a weighted convex-combination based on cross-validation. Asymptotically, this weighted combination of models, called the meta-learner, will outperform any single one of its components.

`lmtp` uses the implementation of the super learner provided by the `SuperLearner` package. The algorithms to be used in the super learner are specified with the `lrnrs_trt` and `lrnrs_outcome` arguments. The outcome variable type should guide users on selecting the appropriate candidate learners for use with the `lrnrs_outcome` argument. Regardless of whether an exposure is continuous, dichotomous, or categorical, the [exposure mechanism is estimated using classification](info_estimators.html#sec-density-ratio-estimation). Therefore only include candidate learners capable of binary classification with the `lrnrs_trt` argument.

Candidate learners that rely on cross-validation for the tuning of hyper-parameters should support grouped data if used with `lrnrs_trt`. Because estimation of the treatment mechanism relies on the augmented $2n$ duplicated data set, duplicated observations must be put into the same fold during sample-splitting. This is done automatically by the package.

### References

Díaz, I., Williams, N., Hoffman, K. L., & Schenck, E. J. (2023). Nonparametric causal effects based on longitudinal modified treatment policies. Journal of the American Statistical Association, 118(542), 846-857.

Williams, N., & Díaz, I. (2023). lmtp: An r package for estimating the causal effects of modified treatment policies. *Observational Studies*, *9*(2), 103-122.

Hoffman, K. L., Schenck, E. J., Satlin, M. J., Whalen, W., Pan, D., Williams, N., & Díaz, I. (2022). Corticosteroids in covid-19: Optimizing observational research through target trial emulations. *medRxiv*, 2022-05.

Van der Laan, M. J., Polley, E. C., & Hubbard, A. E. (2007). Super learner. Statistical applications in genetics and molecular biology, 6(1).
